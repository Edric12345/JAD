<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>SilverCare B2B Partner Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body class="p-4">
  <div class="container">
    <h1>SilverCare Partner Portal (B2B)</h1>
    <p>Load available services and create a checkout session for your client.</p>

    <div class="mb-3">
      <label for="customerEmail" class="form-label">Customer Email (optional for checkout)</label>
      <input id="customerEmail" class="form-control" placeholder="client@example.com">
    </div>

    <div id="services" class="row gy-3"></div>

    <button id="checkoutBtn" class="btn btn-primary mt-3">Create Checkout Session</button>
  </div>

<script>
let stripePubKey = null;
let stripe = null;

async function loadConfig() {
  const res = await fetch('/api/payment/config');
  const cfg = await res.json();
  stripePubKey = cfg.publishableKey;
  if (stripePubKey) stripe = Stripe(stripePubKey);
}

async function loadServices() {
  const res = await fetch('/api/external/services');
  const services = await res.json();
  const container = document.getElementById('services');
  services.forEach(s => {
    const col = document.createElement('div');
    col.className = 'col-md-4';
    col.innerHTML = `
      <div class="card p-3">
        <h5>${s.service_name}</h5>
        <p>${s.description || ''}</p>
        <div><strong>Price: $${s.price}</strong></div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" value="${s.id}" id="svc-${s.id}">
          <label class="form-check-label">Select for checkout</label>
        </div>
      </div>`;
    container.appendChild(col);
  });
}

async function createSession() {
  const checked = Array.from(document.querySelectorAll('#services input[type=checkbox]:checked')).map(cb => parseInt(cb.value));
  if (checked.length === 0) { alert('Please select at least one service'); return; }

  const email = document.getElementById('customerEmail').value || '';

  // Create a session server-side with object payload expected by the API
  const resp = await fetch('/api/payment/create-session', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ serviceIds: checked, customerEmail: email })
  });
  const data = await resp.json();
  if (data.id) {
    if (!stripe) {
      alert('Stripe not initialized. Publishable key missing.');
      return;
    }
    // Redirect to Stripe Checkout
    const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
    if (error) alert(error.message);
  } else {
    alert('Failed to create session');
  }
}

document.getElementById('checkoutBtn').addEventListener('click', createSession);

// Initialize
loadConfig().then(loadServices);
</script>
</body>
</html>
